#!/bin/bash
# Add this at the beginning of all scripts.
if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi
rootDir=$(rootDir)

echo "Installing OpenClaw AI Personal Assistant (cloud-init compatible)" | log

export DEBIAN_FRONTEND="noninteractive"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Install prerequisites
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
apt-get update
installPackage curl git ca-certificates gnupg lsb-release build-essential nginx certbot python3-certbot-nginx jq openssl ufw

# Node.js LTS
if ! command -v node &> /dev/null || [[ "$(node -v)" != v2[0-9]* ]]; then
    echo "Installing Node.js LTS" | log
    curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
    installPackage nodejs
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Install OpenClaw CLI (skip interactive wizard)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "Running official OpenClaw installer" | log
curl -fsSL https://openclaw.ai/install.sh | bash -s -- --no-onboard
waitOrStop 0 "OpenClaw CLI installation failed"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. Run onboarding WITHOUT daemon install (safe in cloud-init)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "Running minimal onboarding (no daemon yet)" | log
openclaw onboard --non-interactive --accept-risk --mode local --skip-daemon || {
    echo "Onboarding failed - continuing anyway (daemon will be installed later)"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. Generate config early (mode local + loopback + token)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GATEWAY_TOKEN=$(openssl rand -hex 30)   # 60 chars

echo "Pre-creating gateway config" | log
mkdir -p ~/.openclaw
cat << EOF > ~/.openclaw/openclaw.json
{
  "gateway": {
    "mode": "local",
    "bind": "loopback",
    "port": 18789,
    "auth": {
      "mode": "token",
      "token": "${GATEWAY_TOKEN}"
    },
    "trustedProxies": ["127.0.0.1"]
  }
}
EOF
chmod 600 ~/.openclaw/openclaw.json

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. Create a post-boot service to finish setup (daemon + Nginx)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "Creating post-boot setup service" | log

cat << EOF > /etc/systemd/system/openclaw-finish-setup.service
[Unit]
Description=OpenClaw post-boot finalization
After=network-online.target

[Service]
Type=oneshot
ExecStart=/opt/openclaw-finish-setup.sh
RemainAfterExit=yes
User=root

[Install]
WantedBy=multi-user.target
EOF

cat << 'EOF' > /opt/openclaw-finish-setup.sh
#!/bin/bash
set -e

# Wait for user session / runtime dir
sleep 10

# Install daemon now (safe after boot)
openclaw daemon install || openclaw gateway install --force

# Enable lingering + start service
loginctl enable-linger $(whoami) || true
systemctl --user daemon-reload
systemctl --user enable --now openclaw-gateway

# Certbot (if not already done - can move here if preferred)
systemctl stop nginx || true
certbot certonly --standalone -d "${CWM_DOMAIN}" \
    --non-interactive --agree-tos -m "admin@${CWM_DOMAIN}" -v || echo "Certbot skipped or failed - check manually"

systemctl start nginx

# Nginx config (same as before)
cat << EON > /etc/nginx/sites-available/openclaw
server {
    listen 80;
    server_name ${CWM_DOMAIN};
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name ${CWM_DOMAIN};

    ssl_certificate /etc/letsencrypt/live/${CWM_DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${CWM_DOMAIN}/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:18789;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_http_version 1.1;
    }
}
EON

ln -sf /etc/nginx/sites-available/openclaw /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default 2>/dev/null
nginx -t && systemctl restart nginx

# Disable self after run
systemctl disable openclaw-finish-setup.service
EOF

chmod +x /opt/openclaw-finish-setup.sh
systemctl daemon-reload
systemctl enable openclaw-finish-setup.service

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. Descriptions (add note about delayed setup)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
descriptionAppend " "
descriptionAppend "ðŸ¦ž OpenClaw AI Personal Assistant installation started!"
descriptionAppend " "
descriptionAppend "Full setup (daemon, certs, Nginx) runs on first boot via systemd service"
descriptionAppend "Check progress: journalctl -u openclaw-finish-setup.service -f"
descriptionAppend " "
descriptionAppend "Control UI (once ready): https://${CWM_DOMAIN}/?token=${GATEWAY_TOKEN}"
descriptionAppend "Gateway token (60 chars - save securely): ${GATEWAY_TOKEN}"
descriptionAppend " "
descriptionAppend "Pairing required on first access (see below)"
descriptionAppend " "
descriptionAppend "!!! PAIRING EXPLANATION !!!"
descriptionAppend "After opening the dashboard, you may see 'disconnected (1008): pairing required'"
descriptionAppend "This is normal security: approve new browsers/devices manually."
descriptionAppend " "
descriptionAppend "Steps:"
descriptionAppend "1. Open https://${CWM_DOMAIN}/?token=${GATEWAY_TOKEN}"
descriptionAppend "2. Look for pairing code in Chat/Overview tab (e.g. ABCDEF-123456)"
descriptionAppend "3. On server run: openclaw pairing list main"
descriptionAppend "4. Approve: openclaw pairing approve main YOUR-CODE-HERE"
descriptionAppend "5. Refresh browser â†’ connected!"
descriptionAppend " "
descriptionAppend "Manage pairings:"
descriptionAppend "  - List: openclaw pairing list main"
descriptionAppend "  - Approve: openclaw pairing approve main CODE"
descriptionAppend "  - Deny: openclaw pairing deny CODE"
descriptionAppend "  - Revoke: openclaw pairing revoke main"
descriptionAppend " "
descriptionAppend "Next steps after boot:"
descriptionAppend "  - Configure model keys: openclaw configure --section models"
descriptionAppend "  - Hatch bot: openclaw tui"
descriptionAppend "  - Logs: journalctl --user -u openclaw-gateway -f"

tagScript success
