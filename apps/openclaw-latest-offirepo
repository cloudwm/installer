#!/bin/bash
# Add this at the beginning of all scripts.
if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi
rootDir=$(rootDir)

echo "Installing OpenClaw AI Personal Assistant with Nginx HTTPS reverse proxy" | log

export DEBIAN_FRONTEND="noninteractive"

apt-get update
installPackage curl git ca-certificates gnupg lsb-release build-essential nginx certbot python3-certbot-nginx jq openssl ufw

# Node.js LTS
if ! command -v node &> /dev/null || [[ "$(node -v)" != v2[0-9]* ]]; then
    echo "Installing Node.js LTS" | log
    curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
    installPackage nodejs
fi

echo "Running OpenClaw global install via npm" | log
npm install -g openclaw
waitOrStop 0 "OpenClaw CLI installation failed"

# Critical fix: refresh PATH and command cache so openclaw is immediately usable
export PATH="/usr/local/bin:/root/.npm-global/bin:$PATH"
hash -r
openclaw --version || waitOrStop 1 "openclaw binary not found after install - PATH issue"

sleep 10  # give npm postinstall hooks a moment

echo "Running minimal onboarding + installing gateway service" | log

# FIX: Ensure proper user session environment
export XDG_RUNTIME_DIR="/run/user/$(id -u)"
mkdir -p "$XDG_RUNTIME_DIR"
chown $(whoami):$(whoami) "$XDG_RUNTIME_DIR"
chmod 700 "$XDG_RUNTIME_DIR"

# Enable lingering FIRST (critical for user services to persist)
loginctl enable-linger $(whoami) || true
sleep 2

# Start D-Bus user session if not running
if ! pgrep -u $(whoami) dbus-daemon > /dev/null; then
    echo "Starting D-Bus user session..." | log
    eval $(dbus-launch --sh-syntax)
    export DBUS_SESSION_BUS_ADDRESS
fi

export OPENCLAW_SKIP_INTERACTIVE=1
export NO_UPDATE_NOTIFIER=1

openclaw onboard --non-interactive --accept-risk --mode local --install-daemon
waitOrStop 0 "Onboarding / daemon setup failed"

GATEWAY_TOKEN=$(openssl rand -hex 30)  # 60 chars

echo "Configuring gateway for loopback + Nginx proxy" | log
mkdir -p ~/.openclaw
cat << EOF > ~/.openclaw/openclaw.json
{
  "gateway": {
    "mode": "local",
    "bind": "loopback",
    "port": 18789,
    "auth": {
      "mode": "token",
      "token": "${GATEWAY_TOKEN}"
    },
    "trustedProxies": ["127.0.0.1"]
  }
}
EOF
chmod 600 ~/.openclaw/openclaw.json

echo "Reloading systemd user daemon..." | log
systemctl --user daemon-reload

# Check if service exists
if ! systemctl --user list-unit-files | grep -q openclaw-gateway; then
    echo "‚ùå openclaw-gateway.service not found in systemd!" | log
    echo "Available user services:" | log
    systemctl --user list-unit-files | grep openclaw | log
    waitOrStop 1 "Gateway service not installed"
fi

echo "Starting OpenClaw gateway service..." | log
# Stop any existing instance first
systemctl --user stop openclaw-gateway 2>/dev/null || true
sleep 2

# Start with detailed error capture
if ! systemctl --user start openclaw-gateway 2>&1 | tee /tmp/gateway-start.log; then
    echo "‚ùå Failed to start gateway. Checking status..." | log
    systemctl --user status openclaw-gateway 2>&1 | tee /tmp/gateway-status.log | log
    echo "Gateway service logs:" | log
    journalctl --user -u openclaw-gateway -n 50 --no-pager 2>&1 | tee /tmp/gateway-journal.log | log
    echo "Checking if port 18789 is already in use:" | log
    netstat -tulpn | grep 18789 | log || echo "Port 18789 is free" | log
    echo "Checking openclaw processes:" | log
    ps aux | grep openclaw | log
    waitOrStop 1 "Failed to start OpenClaw gateway - see logs above"
fi

# Wait and verify it's actually running
sleep 3
if ! systemctl --user is-active --quiet openclaw-gateway; then
    echo "‚ùå Gateway service started but is not active!" | log
    systemctl --user status openclaw-gateway 2>&1 | log
    journalctl --user -u openclaw-gateway -n 50 --no-pager 2>&1 | log
    waitOrStop 1 "Gateway service not running"
fi

# Test if gateway is responding on localhost
echo "Testing gateway connectivity..." | log
sleep 2
if ! curl -f -s -o /dev/null http://127.0.0.1:18789/health 2>/dev/null; then
    echo "‚ö†Ô∏è Gateway service running but not responding on port 18789" | log
    echo "Checking listening ports:" | log
    netstat -tulpn | grep openclaw | log || echo "No openclaw ports found" | log
    journalctl --user -u openclaw-gateway -n 50 --no-pager 2>&1 | log
fi

echo "‚úÖ OpenClaw gateway is running" | log

echo "üîí Attempting to obtain Let's Encrypt SSL certificate..." | log
systemctl stop nginx
if certbot certonly --standalone -d "${CWM_DOMAIN}" \
    --non-interactive --agree-tos \
    -m "admin@${CWM_DOMAIN}" -v; then
    echo "‚úÖ Let's Encrypt SSL certificate active for ${CWM_DOMAIN}" | log
else
    echo "‚ùå Failed to obtain Let's Encrypt SSL certificate for ${CWM_DOMAIN}" | log
    echo "üõë Aborting installation ‚Äî SSL is required." | log
    waitOrStop 1 "Certbot failed"
fi

systemctl start nginx

echo "Configuring Nginx reverse proxy for HTTPS" | log
cat << EOF > /etc/nginx/sites-available/openclaw
server {
    listen 80;
    server_name ${CWM_DOMAIN};
    return 301 https://\$server_name\$request_uri;
}
server {
    listen 443 ssl http2;
    server_name ${CWM_DOMAIN};
    ssl_certificate /etc/letsencrypt/live/${CWM_DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${CWM_DOMAIN}/privkey.pem;
    location / {
        proxy_pass http://127.0.0.1:18789;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_http_version 1.1;
    }
}
EOF

ln -sf /etc/nginx/sites-available/openclaw /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default 2>/dev/null
nginx -t && systemctl restart nginx
waitOrStop 0 "Nginx configuration or restart failed"

# Descriptions with pairing info
descriptionAppend " "
descriptionAppend "ü¶û OpenClaw AI Personal Assistant installed!"
descriptionAppend " "
descriptionAppend "Control UI (Web Dashboard):"
descriptionAppend "https://${CWM_DOMAIN}/?token=${GATEWAY_TOKEN}"
descriptionAppend " "
descriptionAppend "Gateway token (save securely):"
descriptionAppend "${GATEWAY_TOKEN}"
descriptionAppend " "
descriptionAppend "Local gateway endpoint:"
descriptionAppend "http://127.0.0.1:18789"
descriptionAppend " "
descriptionAppend "After opening the dashboard the first time, you will see:"
descriptionAppend " ‚Ä¢ 'disconnected (1008): pairing required'"
descriptionAppend "This is NORMAL and required for security."
descriptionAppend " "
descriptionAppend "Why pairing is needed:"
descriptionAppend " - OpenClaw uses device/session pairing (like WhatsApp Web)"
descriptionAppend " - Prevents unauthorized browsers from accessing your agent/chat"
descriptionAppend " - Must approve new devices/browsers manually on the server"
descriptionAppend " "
descriptionAppend "How to complete pairing:"
descriptionAppend "1. Open the dashboard link above"
descriptionAppend "2. In the Chat or Overview tab, look for a pairing code (e.g. ABCDEF-123456) or QR code"
descriptionAppend " (it may appear automatically or after clicking 'Connect'/'Reconnect')"
descriptionAppend "3. On the server terminal, run:"
descriptionAppend "   openclaw pairing list main"
descriptionAppend " ‚Üí You should see the pending code and browser info"
descriptionAppend "4. Approve it:"
descriptionAppend "   openclaw pairing approve main YOUR-CODE-HERE"
descriptionAppend " (replace YOUR-CODE-HERE with the actual code)"
descriptionAppend "5. Refresh the browser page ‚Üí status should turn green/connected"
descriptionAppend " "
descriptionAppend "Useful pairing commands:"
descriptionAppend " ‚Ä¢ List pending: openclaw pairing list main"
descriptionAppend " ‚Ä¢ Approve: openclaw pairing approve main CODE"
descriptionAppend " ‚Ä¢ Deny: openclaw pairing deny CODE"
descriptionAppend " ‚Ä¢ Revoke all: openclaw pairing revoke main"
descriptionAppend " "
descriptionAppend "If no code appears:"
descriptionAppend " - Refresh page"
descriptionAppend " - Click Chat tab ‚Üí select 'main' session"
descriptionAppend " - Send a test message or click reconnect"
descriptionAppend " - Check browser console (F12 ‚Üí Console) for errors"
descriptionAppend " "
descriptionAppend "Next steps:"
descriptionAppend " ‚Ä¢ Complete pairing as described above"
descriptionAppend " ‚Ä¢ Configure model API keys: openclaw configure --section models"
descriptionAppend " ‚Ä¢ Hatch your bot: openclaw tui"
descriptionAppend " ‚Ä¢ Add channels: openclaw configure --section channels.telegram"
descriptionAppend " ‚Ä¢ Service status: systemctl --user status openclaw-gateway"
descriptionAppend " ‚Ä¢ Logs: journalctl --user -u openclaw-gateway -f"
descriptionAppend " "
descriptionAppend "Troubleshooting logs saved to:"
descriptionAppend " ‚Ä¢ /tmp/gateway-start.log"
descriptionAppend " ‚Ä¢ /tmp/gateway-status.log"
descriptionAppend " ‚Ä¢ /tmp/gateway-journal.log"

tagScript success
