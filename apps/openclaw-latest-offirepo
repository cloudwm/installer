#!/bin/bash
# Add this at the beginning of all scripts.
if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi
rootDir=$(rootDir)

echo "Installing OpenClaw AI Personal Assistant with Nginx HTTPS reverse proxy" | log

export DEBIAN_FRONTEND="noninteractive"

apt-get update
installPackage curl git ca-certificates gnupg lsb-release build-essential nginx certbot python3-certbot-nginx jq openssl ufw

# Node.js LTS
if ! command -v node &> /dev/null || [[ "$(node -v)" != v2[0-9]* ]]; then
    echo "Installing Node.js LTS" | log
    curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
    installPackage nodejs
fi

echo "Running OpenClaw global install via npm" | log
npm install -g openclaw
waitOrStop 0 "OpenClaw CLI installation failed"

# Critical fix: refresh PATH and command cache so openclaw is immediately usable
export PATH="/usr/local/bin:/root/.npm-global/bin:$PATH"
hash -r
openclaw --version || waitOrStop 1 "openclaw binary not found after install - PATH issue"

sleep 10  # give npm postinstall hooks a moment

# Verify openclaw is working
echo "Verifying openclaw installation..." | log
openclaw --help > /tmp/openclaw-help.log 2>&1
if [ $? -ne 0 ]; then
    echo "‚ùå openclaw --help failed:" | log
    cat /tmp/openclaw-help.log | log
    waitOrStop 1 "openclaw binary not working properly"
fi

echo "Running minimal onboarding + installing gateway service" | log

# Setup environment BEFORE onboarding
export XDG_RUNTIME_DIR="/run/user/$(id -u)"
mkdir -p "$XDG_RUNTIME_DIR"
chown $(whoami):$(whoami) "$XDG_RUNTIME_DIR"
chmod 700 "$XDG_RUNTIME_DIR"

# Enable lingering
loginctl enable-linger $(whoami) 2>&1 | tee /tmp/loginctl.log | log
sleep 2

# Start D-Bus session
if ! pgrep -u $(whoami) dbus-daemon > /dev/null; then
    echo "Starting D-Bus user session..." | log
    eval $(dbus-launch --sh-syntax) 2>&1 | tee -a /tmp/dbus.log | log
    export DBUS_SESSION_BUS_ADDRESS
    echo "DBUS_SESSION_BUS_ADDRESS=$DBUS_SESSION_BUS_ADDRESS" | log
fi

# Set all possible environment variables
export OPENCLAW_SKIP_INTERACTIVE=1
export NO_UPDATE_NOTIFIER=1
export HOME=/root
export USER=root
export LOGNAME=root

# Show what we're about to run
echo "Environment before onboarding:" | log
echo "PWD=$(pwd)" | log
echo "HOME=$HOME" | log
echo "USER=$USER" | log
echo "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR" | log
echo "PATH=$PATH" | log
echo "DBUS_SESSION_BUS_ADDRESS=$DBUS_SESSION_BUS_ADDRESS" | log

# Try onboarding with maximum verbosity and error capture
echo "Attempting openclaw onboard..." | log
set -x  # Enable command tracing
openclaw onboard --non-interactive --accept-risk --mode local --install-daemon > /tmp/openclaw-onboard-stdout.log 2> /tmp/openclaw-onboard-stderr.log
ONBOARD_EXIT=$?
set +x  # Disable command tracing

echo "Onboard exit code: $ONBOARD_EXIT" | log

if [ $ONBOARD_EXIT -ne 0 ]; then
    echo "‚ùå Onboarding failed with exit code $ONBOARD_EXIT" | log
    
    echo "=== STDOUT ===" | log
    if [ -f /tmp/openclaw-onboard-stdout.log ]; then
        cat /tmp/openclaw-onboard-stdout.log | log
    else
        echo "No stdout log created" | log
    fi
    
    echo "=== STDERR ===" | log
    if [ -f /tmp/openclaw-onboard-stderr.log ]; then
        cat /tmp/openclaw-onboard-stderr.log | log
    else
        echo "No stderr log created" | log
    fi
    
    # Check if config directory exists
    echo "=== Config directory check ===" | log
    ls -la ~/.openclaw/ 2>&1 | log || echo "~/.openclaw does not exist" | log
    
    # Check systemd user directory
    echo "=== Systemd user directory ===" | log
    ls -la ~/.config/systemd/user/ 2>&1 | log || echo "~/.config/systemd/user does not exist" | log
    
    # Try alternative: skip onboard and manually install daemon
    echo "‚ö†Ô∏è Attempting manual daemon installation as fallback..." | log
    
    # Create minimal config
    mkdir -p ~/.openclaw
    cat << 'EOFCONFIG' > ~/.openclaw/config.json
{
  "mode": "local",
  "gateway": {
    "enabled": true,
    "bind": "127.0.0.1",
    "port": 18789
  }
}
EOFCONFIG
    
    # Try to install daemon separately
    if openclaw daemon install --mode local > /tmp/daemon-install.log 2>&1; then
        echo "‚úÖ Manual daemon installation succeeded" | log
        cat /tmp/daemon-install.log | log
    else
        echo "‚ùå Manual daemon installation also failed" | log
        cat /tmp/daemon-install.log | log
        waitOrStop 1 "Both onboarding and manual daemon install failed"
    fi
else
    echo "‚úÖ Onboarding completed successfully" | log
    cat /tmp/openclaw-onboard-stdout.log | log
fi

GATEWAY_TOKEN=$(openssl rand -hex 30)  # 60 chars

echo "Configuring gateway for loopback + Nginx proxy" | log
mkdir -p ~/.openclaw
cat << EOF > ~/.openclaw/openclaw.json
{
  "gateway": {
    "mode": "local",
    "bind": "loopback",
    "port": 18789,
    "auth": {
      "mode": "token",
      "token": "${GATEWAY_TOKEN}"
    },
    "trustedProxies": ["127.0.0.1"]
  }
}
EOF
chmod 600 ~/.openclaw/openclaw.json

echo "Reloading systemd user daemon..." | log
systemctl --user daemon-reload 2>&1 | log

# Check if service exists
echo "Checking for openclaw services..." | log
systemctl --user list-unit-files 2>&1 | grep -i openclaw | log || echo "No openclaw services found" | log

# Find the actual service name
SERVICE_NAME=""
if systemctl --user list-unit-files | grep -q "openclaw-gateway"; then
    SERVICE_NAME="openclaw-gateway"
elif systemctl --user list-unit-files | grep -q "openclaw"; then
    SERVICE_NAME=$(systemctl --user list-unit-files | grep openclaw | head -1 | awk '{print $1}')
fi

if [ -z "$SERVICE_NAME" ]; then
    echo "‚ùå No openclaw service found!" | log
    echo "Service files in ~/.config/systemd/user/:" | log
    ls -la ~/.config/systemd/user/ | log
    waitOrStop 1 "Gateway service not installed"
fi

echo "Found service: $SERVICE_NAME" | log

# Start the service
echo "Starting $SERVICE_NAME..." | log
systemctl --user stop "$SERVICE_NAME" 2>/dev/null || true
sleep 2

if systemctl --user start "$SERVICE_NAME" 2>&1 | tee /tmp/service-start.log | log; then
    echo "‚úÖ Service start command completed" | log
else
    echo "‚ùå Service start command failed" | log
fi

sleep 3

# Check status
if systemctl --user is-active --quiet "$SERVICE_NAME"; then
    echo "‚úÖ $SERVICE_NAME is active" | log
else
    echo "‚ùå $SERVICE_NAME is not active" | log
    systemctl --user status "$SERVICE_NAME" 2>&1 | tee /tmp/service-status.log | log
    journalctl --user -u "$SERVICE_NAME" -n 100 --no-pager 2>&1 | tee /tmp/service-journal.log | log
    waitOrStop 1 "Service failed to start"
fi

echo "üîí Attempting to obtain Let's Encrypt SSL certificate..." | log
systemctl stop nginx
if certbot certonly --standalone -d "${CWM_DOMAIN}" \
    --non-interactive --agree-tos \
    -m "admin@${CWM_DOMAIN}" -v; then
    echo "‚úÖ Let's Encrypt SSL certificate active for ${CWM_DOMAIN}" | log
else
    echo "‚ùå Failed to obtain Let's Encrypt SSL certificate for ${CWM_DOMAIN}" | log
    echo "üõë Aborting installation ‚Äî SSL is required." | log
    waitOrStop 1 "Certbot failed"
fi

systemctl start nginx

echo "Configuring Nginx reverse proxy for HTTPS" | log
cat << EOF > /etc/nginx/sites-available/openclaw
server {
    listen 80;
    server_name ${CWM_DOMAIN};
    return 301 https://\$server_name\$request_uri;
}
server {
    listen 443 ssl http2;
    server_name ${CWM_DOMAIN};
    ssl_certificate /etc/letsencrypt/live/${CWM_DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${CWM_DOMAIN}/privkey.pem;
    location / {
        proxy_pass http://127.0.0.1:18789;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_http_version 1.1;
    }
}
EOF

ln -sf /etc/nginx/sites-available/openclaw /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default 2>/dev/null
nginx -t && systemctl restart nginx
waitOrStop 0 "Nginx configuration or restart failed"

descriptionAppend " "
descriptionAppend "ü¶û OpenClaw AI Personal Assistant installed!"
descriptionAppend " "
descriptionAppend "Control UI (Web Dashboard):"
descriptionAppend "https://${CWM_DOMAIN}/?token=${GATEWAY_TOKEN}"
descriptionAppend " "
descriptionAppend "Gateway token (save securely):"
descriptionAppend "${GATEWAY_TOKEN}"
descriptionAppend " "
descriptionAppend "Debug logs available at:"
descriptionAppend " ‚Ä¢ /tmp/openclaw-onboard-stdout.log"
descriptionAppend " ‚Ä¢ /tmp/openclaw-onboard-stderr.log"
descriptionAppend " ‚Ä¢ /tmp/service-start.log"
descriptionAppend " ‚Ä¢ /tmp/service-status.log"
descriptionAppend " ‚Ä¢ /tmp/service-journal.log"
descriptionAppend " "
descriptionAppend "Service management:"
descriptionAppend " ‚Ä¢ Status: systemctl --user status $SERVICE_NAME"
descriptionAppend " ‚Ä¢ Logs: journalctl --user -u $SERVICE_NAME -f"
descriptionAppend " ‚Ä¢ Restart: systemctl --user restart $SERVICE_NAME"

tagScript success
