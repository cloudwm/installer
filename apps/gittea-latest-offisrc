#!/bin/bash

if [ -f "include/startup.sh" ]; then
    . include/startup.sh

elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

rootDir="$(rootDir)"
updateStatus="$rootDir/include/updateInstallStatus.sh"
HTML_PATH="/var/www/html/index.html"

MACHINE_IP=$(hostname -I | awk '{print $1}')
DOMAIN_NAME="$(echo "$MACHINE_IP" | tr '.' '-')".cloud-xip.com
echo "Machine IP: $MACHINE_IP" | log
echo "Domain: $DOMAIN_NAME" | log

GITEA_PORT=3000
GITEA_SSH_PORT=2222
GITEA_CONFIG="/var/snap/gitea/common/conf/app.ini"
ADMINPASSWORD='Pass12344321!!'

# ==============================
# Install Gitea via Canonical Snap
# ==============================
install_gittea() {
    echo "Installing Gitea via snap..." | log
    apt-get update
    apt-get install -y snapd
    snap install gitea

    echo "Waiting for Gitea to start initially..." | log
    for i in $(seq 1 30); do
        if curl -sf http://127.0.0.1:${GITEA_PORT}/ > /dev/null 2>&1; then
            echo "Gitea is up after ${i}s." | log
            break
        fi
        sleep 2
    done

    # Wait for app.ini to exist (created on first run)
    echo "Waiting for app.ini to be created..." | log
    for i in $(seq 1 15); do
        [ -f "$GITEA_CONFIG" ] && break
        sleep 2
    done

    if [ ! -f "$GITEA_CONFIG" ]; then
        echo "WARNING: app.ini not found at $GITEA_CONFIG â€” skipping config." | log
        return 1
    fi

    # Stop Gitea while we configure it
    systemctl stop snap.gitea.web.service

    # Generate secrets
    echo "Generating Gitea secrets..." | log
    SECRET_KEY=$(snap run gitea.gitea generate secret SECRET_KEY)
    INTERNAL_TOKEN=$(snap run gitea.gitea generate secret INTERNAL_TOKEN)
    LFS_JWT_SECRET=$(snap run gitea.gitea generate secret LFS_JWT_SECRET)

    # Write a complete app.ini that skips the install wizard
    echo "Writing pre-configured app.ini..." | log
    cat > "$GITEA_CONFIG" <<EOF
APP_NAME = Gitea: Git with a cup of tea
RUN_MODE = prod

[server]
DOMAIN          = ${DOMAIN_NAME}
ROOT_URL        = https://${DOMAIN_NAME}/
HTTP_PORT       = ${GITEA_PORT}
SSH_DOMAIN      = ${DOMAIN_NAME}
SSH_PORT        = ${GITEA_SSH_PORT}
START_SSH_SERVER = true
LFS_START_SERVER = true
LFS_JWT_SECRET  = ${LFS_JWT_SECRET}
OFFLINE_MODE    = false

[database]
DB_TYPE = sqlite3
PATH    = /var/snap/gitea/common/data/gitea.db

[security]
INSTALL_LOCK   = true
SECRET_KEY     = ${SECRET_KEY}
INTERNAL_TOKEN = ${INTERNAL_TOKEN}

[service]
DISABLE_REGISTRATION              = false
REQUIRE_SIGNIN_VIEW               = false
REGISTER_EMAIL_CONFIRM            = false
ENABLE_NOTIFY_MAIL                = false
ALLOW_ONLY_EXTERNAL_REGISTRATION  = false
ENABLE_CAPTCHA                    = false
DEFAULT_KEEP_EMAIL_PRIVATE        = false
DEFAULT_ALLOW_CREATE_ORGANIZATION = true
NO_REPLY_ADDRESS                  = noreply.${DOMAIN_NAME}

[mailer]
ENABLED = false

[openid]
ENABLE_OPENID_SIGNIN = false
ENABLE_OPENID_SIGNUP = false

[picture]
DISABLE_GRAVATAR        = true
ENABLE_FEDERATED_AVATAR = false

[session]
PROVIDER = file

[log]
MODE      = console
LEVEL     = info
ROOT_PATH = /var/snap/gitea/common/log
EOF

    # Start Gitea with new config
    systemctl start snap.gitea.web.service
    echo "Gitea configured and restarted." | log

    # Wait for Gitea to be ready
    for i in $(seq 1 30); do
        curl -sf http://127.0.0.1:${GITEA_PORT}/ > /dev/null 2>&1 && break
        sleep 2
    done

    # Create admin user
    echo "Creating admin user..." | log
    snap run gitea.gitea admin user create \
        --admin \
        --username "root" \
        --password "$ADMINPASSWORD" \
        --email "root@${DOMAIN_NAME}" \
        --must-change-password=false

    echo "Admin user created." | log

    # Open SSH port in firewall if ufw is active
    if command -v ufw &>/dev/null && ufw status | grep -q "active"; then
        ufw allow "${GITEA_SSH_PORT}/tcp"
        echo "Opened port ${GITEA_SSH_PORT} in ufw." | log
    fi
}

# ==============================
# Nginx reverse proxy
# ==============================
switch_nginx_to_proxy() {
    echo "Configuring nginx reverse proxy for Gitea..." | log

    NGINX_CONF="/etc/nginx/sites-available/gitea.conf"

    cat > "$NGINX_CONF" <<EOF
server {
    listen 80;
    server_name ${DOMAIN_NAME};

    client_max_body_size 512M;

    location / {
        proxy_pass http://127.0.0.1:${GITEA_PORT};
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
EOF

    ln -sf "$NGINX_CONF" /etc/nginx/sites-enabled/gitea.conf
    rm -f /etc/nginx/sites-enabled/default 2>/dev/null
    nginx -t || return 1
    systemctl reload nginx

    echo "nginx configured for Gitea." | log
}

# ==============================
# SSL
# ==============================
obtain_ssl() {
    systemctl reload nginx

    echo "Requesting Let's Encrypt certificate..." | log
    certbot --nginx \
        -d "$DOMAIN_NAME" \
        --non-interactive \
        --agree-tos \
        -m "admin@${DOMAIN_NAME}" \
        --redirect

    echo "Gitea available at https://${DOMAIN_NAME}" | log
    "$updateStatus" "$HTML_PATH" -sr
    "$updateStatus" "$HTML_PATH" -ur "Gitea is running on https://${DOMAIN_NAME}"
    "$updateStatus" "$HTML_PATH" -tr "https://${DOMAIN_NAME}"
}

# ==============================
# MOTD
# ==============================
configure_motd() {
    echo "Configuring system MOTD with Gitea info..." | log

    chmod -x /etc/update-motd.d/* 2>/dev/null || true
    rm -f /etc/motd 2>/dev/null

    MACHINE_IP="$(hostname -I | awk '{print $1}')"
    DOMAIN_NAME="$(echo "$MACHINE_IP" | tr '.' '-')".cloud-xip.com
    GITEA_LOCAL_URL="http://127.0.0.1:${GITEA_PORT}"
    GITEA_PUBLIC_URL="https://${DOMAIN_NAME}"
    GITEA_SERVICE_STATUS="$(systemctl is-active snap.gitea.web.service 2>/dev/null || echo unknown)"
    NGINX_STATUS="$(systemctl is-active nginx 2>/dev/null || echo unknown)"

    cat > /etc/motd <<EOM
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ—‚ï¸  Gitea Git Server â€“ Installation Complete
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Local URL: ${GITEA_LOCAL_URL}
    Public URL: ${GITEA_PUBLIC_URL}
    Machine IP: ${MACHINE_IP}
    Domain: ${DOMAIN_NAME}
    Git SSH Port: ${GITEA_SSH_PORT}
    SSH Clone: ssh://git@${DOMAIN_NAME}:${GITEA_SSH_PORT}/

    Admin User: root
    Admin Pass: ${ADMINPASSWORD}

    Gitea Service: ${GITEA_SERVICE_STATUS}
    Nginx Status: ${NGINX_STATUS}

    Install Type: Canonical Snap
    Config File: ${GITEA_CONFIG}
    Data Path: /var/snap/gitea/common/data
    Repositories: /var/snap/gitea/common/data/gitea-repositories
    Database: /var/snap/gitea/common/data/gitea.db (SQLite)
    Logs: /var/snap/gitea/common/log

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ’¡  Gitea management:
    sudo systemctl status snap.gitea.web.service
    sudo systemctl restart snap.gitea.web.service
    sudo snap logs gitea
    sudo nano ${GITEA_CONFIG}

ðŸ“¦  Snap operations:
    sudo snap save gitea          # create backup
    sudo snap saved                # list backups
    sudo snap restore <id> gitea  # restore backup

ðŸ§¹  Remove this message:
    sudo rm -f /etc/motd && sudo chmod +x /etc/update-motd.d/*
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EOM

    chmod 644 /etc/motd
    echo "Custom MOTD installed at /etc/motd with Gitea details." | log
}

# ==============================
# Main
# ==============================
main() {
    "$updateStatus" "$HTML_PATH" -ap "Installing Gitea..."
    install_gittea
    "$updateStatus" "$HTML_PATH" -ap "Finishing installation..."
    switch_nginx_to_proxy
    obtain_ssl
    configure_motd
}

main
