#!/bin/bash

if [ -f "include/startup.sh" ]; then
    . include/startup.sh
	
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh

fi

IP_ADDR="$(awk '{for (i=1;i<=NF;i++) if ($i ~ /[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/) {sub(/.*=/, "", $i); print $i}}' ~/guest.conf)"
EMAIL_ADDR="$(awk -F= '/email=/{print $2}' ~/guest.conf)"
CERT_DIR="/opt/certs"
DRUPAL_DIR="/opt/drupal-site"
DB_NAME="drupal_db"
DB_USER="drupal_user"
DB_PASS="${ADMINPASSWORD}"
DOMAIN="${CWM_DOMAIN}"
LE_FULLCHAIN_PATH="${CERT_DIR}/fullchain.pem"
LE_PRIVKEY_PATH="${CERT_DIR}/privkey.pem"


install_php() {
    echo "Updating system packages..." | log
    apt update || { echo "Failed to update system packages. Exiting."; exit 1; }

    echo "Installing PHP 8.3 and required extensions..." | log
	apt install software-properties-common -y
	add-apt-repository ppa:ondrej/php

    apt install -y php8.3 php-cli php-fpm php-mysql php-xml php-gd php-mbstring php-curl php-zip php-json php-opcache || {
        echo "Failed to install PHP or required extensions. Exiting.";
        exit 1;
    }
	
	sudo systemctl restart php-fpm || {
        echo "Failed to start php-fpm. Exiting." | log;
        exit 1;
    }

    echo "Validating PHP installation..." | log
    PHP_VERSION=$(php -v | grep "^PHP 8.3")
    if [ -z "$PHP_VERSION" ]; then
        echo "PHP 8.3 is not installed correctly. Exiting." | log
        exit 1
		
    fi
    echo "PHP version: $PHP_VERSION" | log

    echo "Checking installed PHP extensions..." | log
    REQUIRED_EXTENSIONS=(cli fpm mysql xml gd mbstring curl zip json opcache)
    MISSING_EXTENSIONS=()
    
    for EXT in "${REQUIRED_EXTENSIONS[@]}"; do
        php -m | grep "$EXT" > /dev/null
        if [ $? -ne 0 ]; then
            MISSING_EXTENSIONS+=("$EXT")
			
        fi
    done

    if [ ${#MISSING_EXTENSIONS[@]} -gt 0 ]; then
        echo "Missing PHP extensions: ${MISSING_EXTENSIONS[@]}. Exiting." | log
        exit 1
		
    else
        echo "All required PHP extensions are installed." | log
		
    fi
}

install_composer() {
    echo "Installing Composer..." | log
    export COMPOSER_ALLOW_SUPERUSER=1

    cd /tmp || { echo "Failed to change directory to /tmp. Exiting."; exit 1; }

    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    
    HASH="$(curl -sS https://composer.github.io/installer.sig)"
    if [ -z "$HASH" ]; then
        echo "Failed to retrieve installer signature. Exiting." | log
        exit 1
		
    fi

    echo "Validating Composer installer hash..." | log
    php -r "if (hash_file('SHA384', 'composer-setup.php') === '$HASH') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); exit(1); } echo PHP_EOL;" || {
        echo "Composer installer verification failed. Exiting." | log
        exit 1
		
    }

    echo "Running Composer setup..." | log
    php composer-setup.php --install-dir=/usr/local/bin --filename=composer || {
        echo "Composer installation failed. Exiting." | log
        exit 1
		
    }

    echo "Cleaning up Composer setup files..." | log
    php -r "unlink('composer-setup.php');"

    # Validate Composer Installation
    echo "Validating Composer installation..." | log
    if [ ! -f "/usr/local/bin/composer" ]; then
        echo "Composer was not found in /usr/local/bin. Exiting." | log
        exit 1
		
    fi

    COMPOSER_VERSION=$(composer --version 2>/dev/null)
    if [ -z "$COMPOSER_VERSION" ]; then
        echo "Composer installation failed or is not working correctly. Exiting." | log
        exit 1
		
    else
        echo "Composer installed successfully: $COMPOSER_VERSION" | log
		
    fi
}

install_drupal() {
    # Create Drupal directory
    echo "Creating Drupal project directory..." | log
    mkdir -p "$DRUPAL_DIR"
    cd "$DRUPAL_DIR" || { echo "Failed to change directory to $DRUPAL_DIR. Exiting." | log; exit 1; }

    # Install Drupal using Composer
    echo "Installing Drupal..." | log
    composer create-project --no-interaction drupal/recommended-project "$DRUPAL_DIR" || { echo "Composer failed to install Drupal. Exiting." | log; exit 1; }

    # Validate Drupal installation by checking if core files exist
    echo "Validating Drupal installation..." | log
    if [ ! -d "$DRUPAL_DIR/web/core" ]; then
        echo "Drupal core files were not found. Installation failed. Exiting." | log
        exit 1
		
    fi

    echo "Installing additional dependencies..." | log
    composer install --no-interaction || { echo "Composer failed to install dependencies. Exiting." | log; exit 1; }

    # Set permissions
    echo "Adjusting file permissions..." | log
    chown -R www-data:www-data "$DRUPAL_DIR" || { echo "Failed to set ownership for $DRUPAL_DIR. Exiting." | log; exit 1; }
    find "$DRUPAL_DIR" -type d -exec chmod 755 {} \; || { echo "Failed to set directory permissions for $DRUPAL_DIR. Exiting." | log; exit 1; }
    find "$DRUPAL_DIR" -type f -exec chmod 644 {} \; || { echo "Failed to set file permissions for $DRUPAL_DIR. Exiting." | log; exit 1; }

    # Validate that permissions are set correctly
    echo "Validating file and directory permissions..." | log
    PERMISSION_ERRORS=0

    find "$DRUPAL_DIR" -type d ! -perm 755 -exec echo "Directory {} has incorrect permissions"  | log \; && PERMISSION_ERRORS=1
    find "$DRUPAL_DIR" -type f ! -perm 644 -exec echo "File {} has incorrect permissions"  | log \; && PERMISSION_ERRORS=1

    if [ $PERMISSION_ERRORS -eq 1 ]; then
        echo "Some files or directories have incorrect permissions. Exiting." | log
        exit 1
		
    fi

    echo "Drupal installation and permission setup completed successfully." | log
}

generate_certs() {
    if [[ ! -d $CERT_DIR ]]; then
        mkdir -p $CERT_DIR
        echo "Created Cert directory: ${CERT_DIR}" | log
    fi

    if ! command -v certbot &> /dev/null; then
        echo "Certbot not found. Installing Certbot..." | log
        sudo apt-get update
        sudo apt-get install -y certbot
    fi

    echo "Obtaining Let's Encrypt certificate for ${DOMAIN}..." | log
    if systemctl is-active --quiet nginx; then
        sudo systemctl stop nginx
        NGINX_STOPPED=true
    fi
	
    if systemctl is-active --quiet apache2; then
        sudo systemctl stop apache2
        APACHE_STOPPED=true
    fi

	echo "DEBUG: Email: ${EMAIL_ADDR}" | log
    sudo certbot certonly --standalone -d "${DOMAIN}" \
        --non-interactive --agree-tos --email "${EMAIL_ADDR}"

    if [ "$NGINX_STOPPED" = true ]; then
        sudo systemctl start nginx
    fi
	
    if [ "$APACHE_STOPPED" = true ]; then
        sudo systemctl start apache2
    fi

    echo "Copying certificates to ${CERT_DIR}..." | log
    CERTBOT_LIVE_DIR="/etc/letsencrypt/live/${DOMAIN}"
    sudo cp "${CERTBOT_LIVE_DIR}/fullchain.pem" "${CERT_DIR}"
    sudo cp "${CERTBOT_LIVE_DIR}/privkey.pem" "${CERT_DIR}"
    sudo chown $(whoami):$(whoami) "${CERT_DIR}"
	
	echo "Creating SAN file..." | log
    cat > "$CERT_DIR/v3.ext" <<-EOF
subjectAltName = @alt_names

[alt_names]
DNS.1 = ${DOMAIN}
IP.1 = ${IP_ADDR}
EOF
    
	echo "Certificate generation complete!" | log
}

config_apache() {
	echo "Configuring Apache Virtual Host..." | log
	bash -c "cat > /etc/apache2/sites-available/drupal.conf <<EOF
<VirtualHost *:80>
     DocumentRoot ${DRUPAL_DIR}/web
     ServerName ${DOMAIN}
     ServerAlias www.${DOMAIN}

     ErrorLog ${APACHE_LOG_DIR}/error.log
     CustomLog ${APACHE_LOG_DIR}/access.log combined

     <Directory ${DRUPAL_DIR}/web>
            Options FollowSymlinks
            AllowOverride All
            Require all granted
     </Directory>

     <Directory ${DRUPAL_DIR}/web>
            RewriteEngine on
            RewriteBase /
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
    </Directory>

    # Redirect all HTTP traffic to HTTPS
    #RewriteEngine on
    #RewriteCond %{HTTPS} !=on
    #RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]
</VirtualHost>

<VirtualHost *:443>
    DocumentRoot ${DRUPAL_DIR}/web
    ServerName ${DOMAIN}
    ServerAlias www.${DOMAIN}

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    <Directory ${DRUPAL_DIR}/web>
        Options FollowSymlinks
        AllowOverride All
        Require all granted
    </Directory>

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile ${LE_FULLCHAIN_PATH}
    SSLCertificateKeyFile ${LE_PRIVKEY_PATH}

    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteBase /
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
    </IfModule>
</VirtualHost>
EOF"

	if ! systemctl is-active --quiet apache2; then sudo systemctl start apache2; fi
	a2enmod rewrite
	a2ensite drupal.conf
	a2dissite 000-default.conf
	systemctl reload apache2
	systemctl restart apache2
}

create_db() {
	echo "Creating Drupal database and user..." | log
	mysql <<MYSQL_SCRIPT
CREATE DATABASE $DB_NAME CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';
GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';
FLUSH PRIVILEGES;
MYSQL_SCRIPT

}


main () {
	apt install php-fpm php-mysql php-gd php-xml php-mbstring php-curl php-zip php-json -y
	
	mysql <<MYSQL_SCRIPT
CREATE DATABASE $DB_NAME CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';
GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';
FLUSH PRIVILEGES;
MYSQL_SCRIPT

	cd /var/www/
	apt install wget -y
	wget https://www.drupal.org/download-latest/tar.gz -O drupal.tar.gz
	tar -xvf drupal.tar.gz
	mv drupal-* drupal
	chown -R www-data:www-data /var/www/drupal
	find /var/www/drupal -type d -exec chmod 755 {} \;
	find /var/www/drupal -type f -exec chmod 644 {} \;

bash -c "cat > /etc/apache2/sites-available/drupal.conf <<EOF
server {
    listen 80;
    server_name ${DOMAIN};

    root /var/www/drupal;
    index index.php index.html index.htm;

    location / {
        try_files $uri /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.ht {
        deny all;
    }
}
EOF"
	
	ln -s /etc/apache2/sites-available/drupal /etc/nginx/sites-enabled/
	systemctl restart apache2
	
	sudo cp /etc/php/8.3/fpm/php.ini /etc/php/8.3/fpm/php.ini.bak
	sudo grep -q '^memory_limit' /etc/php/8.3/fpm/php.ini && sudo sed -i 's/^memory_limit = .*/memory_limit = 256M/' /etc/php/8.3/fpm/php.ini || echo 'memory_limit = 256M' | sudo tee -a /etc/php/8.3/fpm/php.ini
	sudo grep -q '^upload_max_filesize' /etc/php/8.3/fpm/php.ini && sudo sed -i 's/^upload_max_filesize = .*/upload_max_filesize = 100M/' /etc/php/8.3/fpm/php.ini || echo 'upload_max_filesize = 100M' | sudo tee -a /etc/php/8.3/fpm/php.ini
	sudo grep -q '^max_execution_time' /etc/php/8.3/fpm/php.ini && sudo sed -i 's/^max_execution_time = .*/max_execution_time = 300/' /etc/php/8.3/fpm/php.ini || echo 'max_execution_time = 300' | sudo tee -a /etc/php/8.3/fpm/php.ini
	sudo systemctl restart php8.3-fpm
	echo "PHP settings updated and PHP-FPM restarted."

	
	# update_status="$rootDir/include/updateInstallStatus.sh"
	# HTML_PATH="/var/www/html/index.html"
	# if [ ! -f $HTML_PATH ]; then
		# echo "${HTML_PATH} does not exist."
		# exit 1
	# fi
	
	# lines=()
	# done_lines=()
	
	# mark_previous_done() {
		# for (( i=0; i<${#lines[@]}; i++ )); do
			# if [[ ! " ${done_lines[@]} " =~ " ${lines[$i]} " ]]; then	# Check if the line is not already marked as [DONE]
				# lines[$i]="${lines[$i]} [DONE]"
				# done_lines+=("${lines[$i]}")  # Add to done_lines to prevent duplicate updates
			# fi
		# done
	# }

	# display_all_lines() {
		# "$update_status" "$HTML_PATH" -cp
		# for line in "${lines[@]}"; do
			# "$update_status" "$HTML_PATH" -ap "$line"
		# done
	# }
	
	# APACHE_STATUS=$(systemctl status apache2 --no-pager)
	# printf "%s\n" "$APACHE_STATUS" | log
	
	# lines+=("Getting Ready...")
	# echo "Getting Ready..." | log
	# "$update_status" "$HTML_PATH" -cp
	# display_all_lines
	
	# mark_previous_done
	# lines+=("Installing Unzip...")
	# apt install -y unzip
	# display_all_lines
	
	# mark_previous_done
	# lines+=("Installing PHP 8.3...")
	# install_php
	# display_all_lines
	
	# mark_previous_done
	# lines+=("Installing Composer...")
	# install_composer
	# display_all_lines
	
	# mark_previous_done
	# lines+=("Installing Drupal...")
	# install_drupal
	# display_all_lines
	
	# mark_previous_done
	# lines+=("Generating certificates...")
	# generate_certs
	# display_all_lines
	
	# mark_previous_done
	# lines+=("Configuring Apache...")
	# config_apache
	# display_all_lines
	
	# mark_previous_done
	# lines+=("Creating Drupal database...")
	# create_db
	# display_all_lines
	
	descriptionAppend ""
	descriptionAppend "You can now finish the Drupal setup by visiting http://$DOMAIN in your web browser."
	descriptionAppend ""
		
	echo "Installation complete!" | log
	echo "You can now finish the Drupal setup by visiting http://$DOMAIN in your web browser." | log
}

main

# Create Apache Virtual Host
# bash -c "cat > /etc/apache2/sites-available/drupal.conf <<EOF
# <VirtualHost *:80>
     # ServerAdmin ${EMAIL_ADDR}
     # DocumentRoot ${DRUPAL_DIR}/web
     # ServerName ${DOMAIN}
     # ServerAlias www.${DOMAIN}

     # ErrorLog ${APACHE_LOG_DIR}/error.log
     # CustomLog ${APACHE_LOG_DIR}/access.log combined

     # <Directory ${DRUPAL_DIR}/web>
            # Options FollowSymlinks
            # AllowOverride All
            # Require all granted
     # </Directory>

     # <Directory ${DRUPAL_DIR}/web>
            # RewriteEngine on
            # RewriteBase /
            # RewriteCond %{REQUEST_FILENAME} !-f
            # RewriteCond %{REQUEST_FILENAME} !-d
            # RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
    # </Directory>
# </VirtualHost>
# EOF"



# Revert to lets-encrypt once the limit reset.
# TEMP_CERT="/etc/ssl/certs/apache-selfsigned.crt"
# TEMP_KEY="/etc/ssl/private/apache-selfsigned.key"
# sudo mkdir -p /etc/ssl/certs /etc/ssl/private
# sudo openssl req -x509 -newkey rsa:4096 -keyout /etc/ssl/private/apache-selfsigned.key -out /etc/ssl/certs/apache-selfsigned.crt -days 365 -nodes -subj "/CN=${DOMAIN}"

# bash -c "cat > /etc/apache2/sites-available/drupal.conf <<EOF
# # <VirtualHost *:80>
    # # ServerName ${DOMAIN}
    # # Redirect permanent / https://${DOMAIN}/
# # </VirtualHost>

# <VirtualHost *:80>
     # ServerAdmin ${EMAIL_ADDR}
     # DocumentRoot ${DRUPAL_DIR}/web
     # ServerName ${DOMAIN}
     # ServerAlias www.${DOMAIN}

     # ErrorLog ${APACHE_LOG_DIR}/error.log
     # CustomLog ${APACHE_LOG_DIR}/access.log combined

     # <Directory ${DRUPAL_DIR}/web>
            # Options FollowSymlinks
            # AllowOverride All
            # Require all granted
     # </Directory>

     # <Directory ${DRUPAL_DIR}/web>
            # RewriteEngine on
            # RewriteBase /
            # RewriteCond %{REQUEST_FILENAME} !-f
            # RewriteCond %{REQUEST_FILENAME} !-d
            # RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
    # </Directory>
# </VirtualHost>

# <VirtualHost *:443>
	# ServerAdmin ${EMAIL_ADDR}
    # ServerName ${DOMAIN}
    # DocumentRoot $DRUPAL_DIR/web
	# ServerAlias www.${DOMAIN}

    # <Directory $DRUPAL_DIR/web>
		# Options FollowSymlinks
        # AllowOverride All
        # Require all granted
    # </Directory>

    # SSLEngine on
    # SSLCertificateFile ${LE_FULLCHAIN_PATH}
    # SSLCertificateKeyFile ${LE_PRIVKEY_PATH}

    # ErrorLog \${APACHE_LOG_DIR}/drupal_error.log
    # CustomLog \${APACHE_LOG_DIR}/drupal_access.log combined

    # <IfModule mod_rewrite.c>
        # RewriteEngine On
        # RewriteCond %{HTTPS} !=on
        # RewriteRule ^/?(.*) https://%{DOMAIN}/$1 [R,L]
    # </IfModule>
# </VirtualHost>
# EOF"


