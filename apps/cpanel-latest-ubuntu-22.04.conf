#!/bin/bash
set -euo pipefail

LOG_PATH="/var/log/cpanel-install.log"
APPDIR="/opt/cpanel"
CPANEL_INSTALLER_URL="https://securedownloads.cpanel.net/latest"
INSTALLER_OUTPUT="latest"
START_TIME=$(date +%s)

# Source startup if available
if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

nav_to_appdir() {
    if [ ! -d "$APPDIR" ]; then
        echo "Creating directory ${APPDIR}..." | log
        mkdir -p "$APPDIR" || { echo "Failed to create ${APPDIR}" | log; exit 1; }
    fi

    echo "Navigating to ${APPDIR}..." | log
    cd "$APPDIR" || { echo "Failed to change directory to ${APPDIR}" | log; exit 1; }

    if [ "$(pwd)" != "$APPDIR" ]; then
        echo "Error: Current directory ($(pwd)) does not match ${APPDIR}." | log
        exit 1
    fi
    echo "Successfully navigated to ${APPDIR}." | log
}

disable_firewall() {
    echo "Disabling firewall..." | log
    iptables-save > ~/firewall.rules
    systemctl stop ufw.service || true
    systemctl disable ufw.service || true
}

install_dependencies() {
    echo "Installing dependencies..." | log
    apt -y install perl perl-base chrony curl
}

set_hostname() {
    echo "Configuring hostname..." | log
    local ip
    ip=$(hostname -I | awk '{print $1}')
    if [[ -z "$ip" ]]; then
        echo "No IP address found!" | log
        exit 1
    fi
    local formatted_ip
    formatted_ip=$(echo "$ip" | tr '.' '-')
    local new_hostname="${formatted_ip}.cloud-xip.com"
    sudo hostnamectl set-hostname "$new_hostname"
    echo "Hostname set to: $new_hostname" | log
}

add_rdate_hosts_entry() {
    echo "Adding rdate host entry..." | log
    local host_entry="127.0.0.1   rdate.cpanel.net"
    if grep -E -q '127\.0\.0\.1\s+.*rdate\.cpanel\.net' /etc/hosts; then
        echo "Entry for rdate.cpanel.net already exists in /etc/hosts." | log
    else
        echo "$host_entry" | sudo tee -a /etc/hosts >/dev/null && \
            echo "Entry added successfully." | log || \
            echo "Failed to add entry. Please check your permissions." | log
    fi
}

sync_time() {
    echo "Syncing time..." | log
    chronyc tracking
    chronyc makestep

    echo "Moving rdate file..." | log
    mv /usr/sbin/rdate /usr/sbin/rdate.orig || true

    echo "Creating dummy rdate..." | log
    cat << 'EOF' | sudo tee /usr/sbin/rdate >/dev/null
#!/bin/bash
# Dummy rdate command for cPanel installation workaround.
exit 0
EOF
    chmod +x /usr/sbin/rdate
}

add_gpg_key() {
    echo "Adding GPG Key..." | log
    local key="A8D3785C"
    local ks="hkp://keyserver.ubuntu.com:80"
    if gpg --batch --no-tty --keyserver "$ks" --recv-keys "$key"; then
        echo "Successfully downloaded GPG key $key." | log
    else
        echo "Failed to download GPG key $key using --recv-keys. Trying search method..." | log
        if printf "1\n" | gpg --batch --no-tty --keyserver "$ks" --search-keys "$key"; then
            echo "Successfully imported GPG key $key using search method." | log
        else
            echo "Error: Unable to download GPG key $key from $ks." | log
        fi
    fi
}

import_mysql_gpg_keys() {
    echo "Importing MySQL GPG keys..." | log
    local keys=("A8D3785C" "3A79BD29" "5072E1F5" "C74CD1D8")
    local keyservers=("hkps://keyserver.ubuntu.com" "hkps://keys.openpgp.org")
    for key in "${keys[@]}"; do
        local imported=0
        echo "Attempting to import key: $key" | log
        for ks in "${keyservers[@]}"; do
            if gpg --batch --no-tty --keyserver "$ks" --recv-keys "$key"; then
                echo "Successfully imported key $key from $ks." | log
                imported=1
                break
            else
                echo "Failed to import key $key from $ks. Trying search method..." | log
                if printf "1\n" | gpg --batch --no-tty --keyserver "$ks" --search-keys "$key"; then
                    echo "Successfully imported key $key using search method from $ks." | log
                    imported=1
                    break
                else
                    echo "Search method failed for key $key from $ks." | log
                fi
            fi
        done
        if [ "$imported" -eq 0 ]; then
            echo "Error: Unable to import key $key from any keyserver." | log
        fi
    done
}

import_cpanel_keys() {
    echo "Importing cPanel GPG keys..." | log
    local keys=("A8D3785C" "3A79BD29" "5072E1F5" "C74CD1D8")
    local keyservers=("hkp://keyserver.ubuntu.com:80" "hkps://keys.openpgp.org")
    for key in "${keys[@]}"; do
        local imported=0
        echo "Attempting to import key: $key" | log
        for ks in "${keyservers[@]}"; do
            if gpg --batch --no-tty --keyserver "$ks" --recv-keys "$key"; then
                echo "Successfully imported key $key from $ks." | log
                imported=1
                break
            else
                echo "Failed to import key $key from $ks. Trying search method..." | log
                if printf "1\n" | gpg --batch --no-tty --keyserver "$ks" --search-keys "$key"; then
                    echo "Successfully imported key $key using search method from $ks." | log
                    imported=1
                    break
                else
                    echo "Search method failed for key $key from $ks." | log
                fi
            fi
        done
        if [ "$imported" -eq 0 ]; then
            echo "Error: Unable to import key $key from any keyserver." | log
        fi
    done
}

import_mariadb_apt_key() {
    echo "Importing MariaDB repository key..." | log
    if curl -fsSL https://mariadb.org/mariadb_release_signing_key.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/mariadb.gpg; then
        echo "Successfully imported MariaDB repository key." | log
    else
        echo "Error: Unable to import MariaDB repository key." | log
        exit 1
    fi
}

download_cpanel_installation() {
    nav_to_appdir
    echo "Downloading cPanel installation script from ${CPANEL_INSTALLER_URL}..." | log
    if ! curl -f -L -o "${APPDIR}/${INSTALLER_OUTPUT}" "${CPANEL_INSTALLER_URL}"; then
        echo "Error: Failed to download from ${CPANEL_INSTALLER_URL}" | log
        exit 1
    fi
    echo "Download complete: ${APPDIR}/${INSTALLER_OUTPUT}" | log
}

run_installation_script() {
    echo "Running cPanel installation script..." | log
    # Clear log file before starting
    : > "$LOG_PATH"

    # Start the installer in the background and capture its PID
    bash "${APPDIR}/${INSTALLER_OUTPUT}" 2>&1 | tee -a "$LOG_PATH" &
    installer_pid=$!

    # Tail the log file and monitor output
    tail -n0 -f "$LOG_PATH" | while IFS= read -r line; do
        # Look for the one-time autologin URL
        if [[ "$line" =~ https://[^[:space:]]*login/\?session=.* ]]; then
            AUTLOGIN_URL="$line"
            echo "Found one-time autologin URL: $AUTLOGIN_URL" | log
        fi
        # When the completion message is seen, kill the installer process
        if [[ "$line" == *"Thank you for installing cPanel & WHM"* ]]; then
            echo "Detected completion message." | log
            kill "$installer_pid"
            break
        fi
    done

    # Wait for the installer process to exit (ignore errors if already killed)
    wait "$installer_pid" 2>/dev/null || true
}

post_install_cleanup() {
    local END_TIME
    END_TIME=$(date +%s)
    local DURATION=$((END_TIME - START_TIME))
    echo "Installation completed in ${DURATION} seconds." | log
    bash tweaks/motd-description-append || true
    bash tweaks/cwm-description-autoconfig || true
    if [[ -n "${AUTLOGIN_URL:-}" ]]; then
        descriptionAppend "One-time autologin URL: ${AUTLOGIN_URL}"
        descriptionAppend ""
    fi
    descriptionAppend "cPanel Web UI: https://${CWM_DOMAIN}:2087"
    tagScript success
}

main() {
    echo "Starting cPanel setup..." | log
    disable_firewall
    install_dependencies
    set_hostname
    add_rdate_hosts_entry
    sync_time
    add_gpg_key
    import_mysql_gpg_keys
    import_cpanel_keys
    import_mariadb_apt_key
    apt update
    download_cpanel_installation
    run_installation_script
    post_install_cleanup
}

main
