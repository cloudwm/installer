#!/bin/bash

# --- setup and vars ---
if [ -f "include/startup.sh" ]; then
    . include/startup.sh
elif [ -f "../include/startup.sh" ]; then
    . ../include/startup.sh
fi

rootDir="$(rootDir)"
updateStatus="$rootDir/include/updateInstallStatus.sh"
LOG_PATH="/var/log/ollama-setup.log"
HTML_PATH="/var/www/html/index.html"
MACHINE_IP=$(hostname -I | awk '{print $1}')
[ -z "$MACHINE_IP" ] && MACHINE_IP=$(ip route get 1.1.1.1 | awk '{print $7; exit}')
echo "Machine IP: $MACHINE_IP" | log
[ -f "$LOG_PATH" ] || touch "$LOG_PATH"

declare -a pre_display_list
declare -A seen

echo "Opening Ollama's default port: 11434..." | log
ufw allow 11434/tcp

# --- kick off installer in background ---
echo "Installing Ollama..." | log
"$updateStatus" "$HTML_PATH" -ap "Installing Ollama (Might take some time)..."
curl -fsSL https://ollama.com/install.sh | sh | tee "$LOG_PATH" &   # background
INSTALL_PID=$!

# --- stream log to Web UI as it grows ---
tail -f "$LOG_PATH" | while read -r line; do
    [[ "$line" == *"==> "* ]] || continue
    [[ "$line" == *"Pulling docker images"* ]] && line="Pulling docker images (Takes some time)..." || line="${line#*==> }"
    if [[ -z "${seen[$line]}" ]]; then
        seen[$line]=1
        pre_display_list+=("$line")
        "$updateStatus" "$HTML_PATH" -cp
        for stage in "${pre_display_list[@]}"; do
            cleaned=$(echo "$stage" | sed 's/\.*$//')
            "$updateStatus" "$HTML_PATH" -ap "${cleaned}..."
        done
    fi
done &

wait $INSTALL_PID   # wait for installer to finish

# --- systemd tweak for external access ---
SERVICE_FILE="/etc/systemd/system/ollama.service"
if [ -f "$SERVICE_FILE" ] && ! grep -q '^Environment=OLLAMA_HOST=0.0.0.0:11434' "$SERVICE_FILE"; then
    sed -i '/^\[Service\]/a Environment=OLLAMA_HOST=0.0.0.0:11434' "$SERVICE_FILE"
    systemctl daemon-reload
    systemctl restart ollama
    echo "Added Environment=OLLAMA_HOST=0.0.0.0:11434 to $SERVICE_FILE and restarted service." | log
fi

"$updateStatus" "$HTML_PATH" -sr
"$updateStatus" "$HTML_PATH" -ur "Ollama API is ready at http://${MACHINE_IP}:11434"
"$updateStatus" "$HTML_PATH" -tr "http://${MACHINE_IP}:11434"

sleep 10
echo "Installation complete. Stopping and removing Apache2..." | log
systemctl stop apache2
systemctl disable apache2
apt purge -y apache2 apache2-utils apache2-bin apache2.2-common
apt autoremove -y
apt clean
echo "Apache2 service stopped and removed." | log

tag Script.success
